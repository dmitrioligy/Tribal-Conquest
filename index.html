<!DOCTYPE html>

<!-- Copied from stackoverflow to disable caching -->
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />
<!---------------------------------------------------->

<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="Game.js"></script>
<script src="Render.js"></script>
<script src="Unit.js"></script>
<script src="Move-Attack.js"></script>
<script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.1.min.js"></script>

<head>
<style>

    #searching_section
    {
        position:absolute;
        width:300px;
        height:200px;
        z-index:15;
        top:50%;
        left:50%;
        margin:-100px 0 0 -150px;
        color: white;
    }

    #status
    {
        font-weight:bold;
    }

    #background
    {
        background-size: 100%;
        background-repeat: no-repeat;
        background-color: black;
    }

  #container {
    position: fixed;
    width: 100%;
    height: 100%;
    left: 0;
    top: 0;
    background: rgba(51,51,51,0.4);
    display: none;
  }

</style>
</head>

<div id="warning">
	JavaScript is required to run this app.
</div>


<div id="searching_section">

    <body id="background" background="background.jpg">

	<div id="status"> Connecting to Tribal Conquest ...</div>

    <br> Gamer Tag: 
	<input id="name" type="text"/>


    <!-- Host can only see this to choose game specifications -->
    <div id="host">
        <br> Number of Players (2-4): 
        <input id="num_players" type="number" min="2" max ="4"/>

        <br>
        <br> Max Score to Win: <br>
        <input id="max_score" type ="checkbox" value="10"/> 10 Points <br>
        <input id="max_score" type ="checkbox" value="15"/> 15 Points <br>
        <input id="max_score" type ="checkbox" value="15"/> 20 Points <br>
    </div>

    <br> 
    <input id="find" type="button" value="Find Game" disabled="true"/>
     

    </body>
</div>

<div id="container"></div>
<script>
  // $(document) returns a jQuery object representing the whole document (page).
  // $(document).ready(fn) tells jQuery to call function 'fn' after the whole
  // document is loaded.
  var name = "";
  var num_players = "";
  var max_score = "";
  $(document).ready(function() {
    // Hide the warning section and show the login section.
    $('#warning').css('display', 'none');
    $('#searching_section').css('display', 'block');
    $('#game').css('display', 'none');
    
    // Initialize socket.io.
    // document.location.host returns the host of the current page.
    
    // Local
    var socket = io.connect('http://' + document.location.host);

    // Hosted
    // var socket =  io.connect('http://dmitrioligy.kd.io:8000');

    // If a welcome message is received, it means the chat room is available.
    // The Log In button will be then enabled.
    socket.on
    (
    	'welcome',
    	function(message) 
    	{
    		$('#status').text(message.welcome);
    		$('#find').attr('disabled', false);

            // if first player, give host tooltip
            if (message.numOfPlayers == 0)
            {
                $('#host').attr('disabled', false);
            }
            if (message.numOfPlayers > 0)
            {
                $('#host').attr('disabled', true);
            }
        }
    );


    socket.on
    (
    	'searching',
    	function(message)
    	{
    		$('#status').text(message);
    		$('#find').attr('disabled', true);
    		$('#find').attr('visible', false);
    		document.getElementById('find').style.visibility = 'hidden';  
    	}
    );


    // Start Game Initialization
    var game, render;
    socket.on
    (
    	'start_game',
    	function(message) 
    	{  
            // Hide search section. Start game, pass playerlist and max_score.
            // Render the display of the game
    		$('#searching_section').css('display', 'none');
            $('#container').css('display', 'block');
    		game = new Game();
            Game.Max_Score = message.max_score;
    		game.Initialize(message.allPlayers);
    		render = new Render(game, socket);

     	}
    );


    socket.on
    (
    	'failed_find_game',
    	function() 
    	{
    		$('#status').text('Failed to find a game!');
    	}
    );

    // Sync player move/attack
    socket.on
    (
    	'sync_client_action',
    	function(message) 
    	{
    		// Simulating the clicks on other clients 
           	render.synchronizeTurn(message.oldX, message.oldY, message.newX, message.newY, message.owner);
    	}
    );


    socket.on
    (
    	'next_turn',
    	function()
    	{
    		game.Next_Turn();
    	}
    );


    $('#find').click
    (
    	function() 
	    {
	    	name = $('#name').val();
            num_players = $('#num_players').val();
            max_score = $('#max_score').val();
	    	if (name) 
	    	{
	    		name = name.trim();
                num_players = num_players.trim();
                max_score = max_score.trim();
	    		if ( name.length > 0) 
	    		{
	    			socket.emit('find_game', { player_name: name,
                                                num_players: num_players,
                                                max_score: max_score } );
	    		}
	    	}
		      // Clear the input field.
		}
	);

    // When Enter is pressed in the name field, it should be treated as clicking
    // on the Log In button.
    $('#name').keyup
    (
	    function(event) 
	    {
	    	if (event.keyCode == 13) 
	    	{
	    		$('#find').click();
	    	}
	    }
	);

	    
	});
</script>